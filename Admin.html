<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head>
	<title>Administrative Page</title>	
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<header id="my-header">
		<div class="container">
			<ul><li>
				<a href="Home.html">Home</a></li><li>
				<a href="ShowCase.html">Projects</a></li><li>				
				<a href="https://github.com/AboutTreeFittyy">GitHub</a></li><li>				
				<a href="https://www.linkedin.com/">LinkedIn</a></li><li>
				<a href="Admin.html">Temp</a></li><li>
				<a href="EncodedLiving.html">Game</a></li><li>
			</li></ul>
		</div>		
	</header>
	<section class="my-form" id="my-form">
		<div class="container">
			<h1>ShowCase Management</h1>
			<div id="imageTest"><img id="test1"><img id="test2"><img id="test3"></div>
			
			<form enctype="multipart/form-data" id="uploadProject" method="post">
				<h2>Add New Project:</h2>
				Title <input type="text" id="projectTitle" name="title"><br>
				Description<input type="text" id="projectDescription" name="description"><br>
				Add Skills: 
				<div id="addSkills"></div>
				<br>Add Image:<br>
				<input class="button" id="projectImage" type="file" name="file"><br><br>
				<input class="button" type="submit" name="upload" value="upload"><br><br>
			</form>
			
			<h2>Delete Project:</h2>
			<div id="deleteProjects"></div>
			
			<form enctype="multipart/form-data" action=".php" method="post">
				<h2>Edit Item Order:</h2>
				<div id="orderSkills"></div>
			</form>
			
			<h1>HomePage Management</h1>

			<h2>Add New Skill:</h2>
			Title<input type="text" name="newtitle"><br>
			Summary<input type="text" name="summary"><br>

			<h2>Remove Skill:</h2>
			<div id="deleteSkills"></div>
			<h2>Change Home Page Data</h2>
			<form enctype="multipart/form-data" action=".php" method="post">
				Change Main Picture:
				<input class="button" type="submit" value="Upload Photo"><br>
				Name<input type="text" name="name"><br>
				Description<input type="text" name="namedescription"><br>
				<input class="button" type="submit" value="Save Changes">
			</form> 
		</div>
	</section>
	<div class="container">
		<footer id="my-footer">
			<p>Author: Mathew Boland - Last Updated:October 17, 2019</p>
		</footer>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
	<script type="text/javascript" src="HTMLGenerator.js"></script>
	<script type="text/javascript" src="AdminManager.js"></script>
	<script>
		var toPrint = '';
		function printPage(){
			//Add sections with skills that need to be selected
			setAdminSkillsData();
			toPrint = getAdminSkillsData();
			document.getElementById('addSkills').innerHTML = toPrint;
			document.getElementById('deleteSkills').innerHTML = toPrint;
			//Add section for skills to be ordered
			setAdminReorderData();
			toPrint = getAdminReorderData();
			document.getElementById('orderSkills').innerHTML = toPrint;
			//Now add project data 
			setAdminProjectData();
			toPrint = getAdminProjectData();
			document.getElementById('deleteProjects').innerHTML = toPrint;
		}
		//set printPageContents to run when page loads
		window.onload = printPage;
		
		$(document).ready(function(){		 
			$('#uploadProject').on('submit', function(event){
				event.preventDefault();
				//Get image from form and make copies for db
				var file = document.querySelector('input[type=file]').files[0];
				var reader = new FileReader();
				var main_image, mobile_image, thumbnail;
				var image = new Image();
				reader.readAsDataURL(file);
				reader.onload = () =>{					
					image.src = reader.result;	
					image.onload = () =>{
						main_image = normalizeImage(image);
						if(main_image != null){
							//alert("Valid Photo");
							mobile_image = createMobileImageCopy(main_image);
							thumbnail = createThumbNailCopy(main_image);
							var image_name = $('#projectImage').val();
							var path = document.getElementById('projectImage').value;
							//Get file name with extension
							var file_name;
							if (path) {
								var start = (path.indexOf('\\') >= 0 ? path.lastIndexOf('\\') : path.lastIndexOf('/'));
								file_name = path.substring(start);
								if (file_name.indexOf('\\') === 0 || file_name.indexOf('/') === 0) {
									file_name = file_name.substring(1);
								}
							}
							document.getElementById("test1").src = main_image;
							document.getElementById("test2").src = mobile_image;
							document.getElementById("test3").src = thumbnail;
							//contains data for database only
							var data = {
							"title" : document.getElementById("projectTitle").value,
							"description" : document.getElementById("projectDescription").value,
							"fileName" : file_name
							};							
							var dataString = JSON.stringify(data);
							//Now send the ShowCase data so it can be added to the database
							$.ajax({
								url:"addShowCaseData.php",
								method: "POST",
								data: {myData: dataString},
								success:function(data){
									alert(data);
								}
							});
							//Now send the photos to the server to be saved for future hosting						
							//var blob = dataURItoBlob(main_image);
							var formData = new FormData();
							formData.append('main', dataURItoBlob(main_image), file_name);
							formData.append('mobile', dataURItoBlob(mobile_image), "M_"+file_name);
							formData.append('thumb', dataURItoBlob(thumbnail), "TN_"+file_name);
							//Now send the ShowCase photos so it can be saved to the server
							$.ajax({
								url:"addShowCasePhotos.php",
								method: "POST",
								data: formData,
								processData: false,
								contentType: false,
								success:function(data){
									alert(data);
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
								}
							});
						}else{
							alert("Invalid Photo Uploaded");
						}
					};					
				};	
			});		 
		});  
		/* Function Name: dataURItoBlob
		 * Source: https://stackoverflow.com/questions/6850276/how-to-convert-dataurl-to-file-object-in-javascript
		 * Date Written: May 23, 2017
		 * Author: Matthew
		 */
		function dataURItoBlob(dataURI) {
		  // convert base64 to raw binary data held in a string
		  // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
		  var byteString = atob(dataURI.split(',')[1]);
		  // separate out the mime component
		  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
		  // write the bytes of the string to an ArrayBuffer
		  var ab = new ArrayBuffer(byteString.length);
		  // create a view into the buffer
		  var ia = new Uint8Array(ab);
		  // set the bytes of the buffer to the correct values
		  for (var i = 0; i < byteString.length; i++) {
			  ia[i] = byteString.charCodeAt(i);
		  }
		  // write the ArrayBuffer to a blob, and you're done
		  var blob = new Blob([ab], {type: mimeString});
		  return blob;
		}
	</script>
</body>
</html>