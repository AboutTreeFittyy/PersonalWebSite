<!doctype html>
<html lang="en">
<meta charset="utf-8">
<head>
	<title>Administrative Page</title>	
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<header id="my-header">
		<div class="container">
			<ul><li>
				<a href="Home.html">Home</a></li><li>
				<a href="ShowCase.html">Projects</a></li><li>				
				<a href="https://github.com/AboutTreeFittyy">GitHub</a></li><li>				
				<a href="https://www.linkedin.com/">LinkedIn</a></li><li>
				<a href="Admin.html">Temp</a></li><li>
				<a href="EncodedLiving.html">Game</a></li><li>
			</li></ul>
		</div>		
	</header>
	<section class="my-form" id="my-form">
		<div class="container">
			<h1>ShowCase Management</h1>
			<div id="imageTest"><img id="test1"><img id="test2"><img id="test3"></div>
			
			<form enctype="multipart/form-data" id="uploadProject" method="post">
				<h2>Add New Project:</h2>
				Title <input type="text" id="projectTitle" name="title"><br>
				Description<input type="text" id="projectDescription" name="description"><br>
				Select Skills for Project: 
				<div id="addSkills"></div>
				<br>Add Image:<br>
				<input class="button" id="projectImage" type="file" name="projectImage"><br><br>
				<input class="button" type="submit" name="upload" value="Save New Project"><br><br>
			</form>
			
			<form enctype="multipart/form-data" id="deleteProject" method="post">
				<h2>Delete Project:</h2>
				<div id="deleteProjects"></div>
				<input class="button" type="submit" name="deleteProject" value="Delete Selected Project(s)"><br><br>
			</form>
			
			<form enctype="multipart/form-data" id="reorderSkills" method="post">
				<h2>Edit Project Order:</h2>
				<div id="orderSkills"></div>
			</form>
			
			<h1>HomePage Management</h1>
			
			<form enctype="multipart/form-data" id="addNewSkill" method="post">
				<h2>Add New Skill:</h2>
				Title<input type="text" id="newSkillTitle" name="newtitle"><br>
				Summary<input type="text" id="newSkillDescription" name="summary"><br><br>
				<input class="button" type="submit" name="saveSkill" value="Save Skill"><br><br>
			</form>			
			
			<form enctype="multipart/form-data" id="deleteSkill" method="post">
				<h2>Remove Skill:</h2>
				<div id="deleteSkills"></div>
				<input class="button" type="submit" name="deleteSkill" value="Delete Selected Skill(s)"><br><br>
			</form>			
			
			<form enctype="multipart/form-data" id="uploadHome" method="post">
				<h2>Change HomePage Data:</h2>
				Name <input type="text" id="homeTitle" name="homeTitle"><br>
				Description<input type="text" id="homeDescription" name="homeDescription">
				<br>Main Image:<br>
				<input class="button" id="homeImage" type="file" name="homeImage"><br><br>
				<input class="button" type="submit" name="saveNewHomePage" value="Save New HomePage"><br><br>
			</form>
		</div>
	</section>
	<div class="container">
		<footer id="my-footer">
			<p>Author: Mathew Boland - Last Updated:October 17, 2019</p>
		</footer>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
	<script type="text/javascript" src="HTMLGenerator.js"></script>
	<script type="text/javascript" src="AdminManager.js"></script>
	<script>
		function changeOrder(id, order){
			//var orderData = getAdminProjectData();
			//Get project info of two that are chaning orders
			var thisTitle = document.getElementById("dds"+id);
			var otherTitle = document.querySelector("button[value='"+order+"']");	
			//save the current order of the title clicked
			var curOrder = thisTitle.value;
			//swap the values of the projects
			thisTitle.value = otherTitle.value;
			otherTitle.value = curOrder;
			//switch text displayed on buttons
			thisTitle.innerText = "["+(1+Number(order))+"] "+thisTitle.innerText.substring(4);
			otherTitle.innerText = "["+(1+Number(curOrder))+"] "+otherTitle.innerText.substring(4);
			//Okay so actually should just ajax request this when clicked
			var data = {
			"from_id" : Number(id),
			"from_order" : order,
			"to_id" : Number(otherTitle.id.substring(3)),
			"to_order" : Number(curOrder)
			};							
			var dataString = JSON.stringify(data);
			$.ajax({
				url:"changeProjectOrder.php",
				method: "POST",
				data: {myData: dataString},
				success:function(data){
					alert(data);
				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
				}
			});
			//reload the div so that it updates properly
			setAdminProjectData();
		}		
		
		$(document).ready(function(){		 
			$('#deleteSkill').on('submit', function(event){
				event.preventDefault();
				//Get data for projects so we know which ids to look for
				var skillData = getAdminSkillsData();
				for(var i = 0; i < skillData.length; i++){
					//Check if that id exists
					if(document.getElementById("deleteSkill"+skillData[i].skill_id)){
						//Make sure its checked, if it is then send an ajax request to delete it
						if(document.getElementById("deleteSkill"+skillData[i].skill_id).checked){
							$.ajax({
								url:"deleteSkill.php",
								method: "POST",
								data: {myData: JSON.stringify(skillData[i].skill_id)},
								success:function(data){
									alert(data);
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
								}
							});
							//stop displaying the div from the page as its gone now for that skill everywhere
							document.getElementById("psd"+skillData[i].skill_id).style.display = 'none';
							document.getElementById("dsd"+skillData[i].skill_id).style.display = 'none';
						}					
					}
				}
			});		 
		}); 		
		
		$(document).ready(function(){		 
			$('#deleteProject').on('submit', function(event){
				event.preventDefault();
				//Get data for projects so we know which ids to look for
				var projectData = getAdminProjectData();
				for(var i = 0; i < projectData.length; i++){
					//Check if that id exists
					if(document.getElementById("deleteProjectSkill"+projectData[i].showcase_id)){
						//Make sure its checked, if it is then send an ajax request to delete it
						if(document.getElementById("deleteProjectSkill"+projectData[i].showcase_id).checked){
							$.ajax({
								url:"deleteProject.php",
								method: "POST",
								data: {myData: JSON.stringify(projectData[i].showcase_id)},
								success:function(data){
									//alert(data);
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
								}
							});
							//stop displaying the div from the page as its gone now
							document.getElementById("dps"+projectData[i].showcase_id).style.display = 'none';
						}					
					}
				}
			});		 
		}); 
		
		$(document).ready(function(){		 
			$('#uploadHome').on('submit', function(event){
				event.preventDefault();
				//Get image from form and save to site
				var file = document.querySelector('#homeImage').files[0];
				//var file = $('#homeImage').prop('files');
				var reader = new FileReader();
				var main_image;
				var image = new Image();
				reader.readAsDataURL(file);
				reader.onload = () =>{					
					image.src = reader.result;	
					image.onload = () =>{
						main_image = normalizeImage(image);
						if(main_image != null){
							var image_name = $('#homeImage').val();
							var path = document.getElementById('homeImage').value;
							//Get file name with extension
							var file_name;
							if (path) {
								var start = (path.indexOf('\\') >= 0 ? path.lastIndexOf('\\') : path.lastIndexOf('/'));
								file_name = path.substring(start);
								if (file_name.indexOf('\\') === 0 || file_name.indexOf('/') === 0) {
									file_name = file_name.substring(1);
								}
							}
							//contains data for database only
							var data = {
							"title" : document.getElementById("homeTitle").value,
							"description" : document.getElementById("homeDescription").value,
							"fileName" : file_name
							};							
							var dataString = JSON.stringify(data);
							//Now send the ShowCase data so it can be added to the database
							$.ajax({
								url:"addHomePageData.php",
								method: "POST",
								data: {myData: dataString},
								success:function(data){
									//alert(data);
								}
							});
							//Now send the photos to the server to be saved for future hosting						
							var formData = new FormData();
							formData.append('main', dataURItoBlob(main_image), file_name);
							//Now send the ShowCase photos so it can be saved to the server
							$.ajax({
								url:"addHomePagePhoto.php",
								method: "POST",
								data: formData,
								processData: false,
								contentType: false,
								success:function(data){
									//alert(data);
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
								}
							});
						}else{
							alert("Invalid Photo Uploaded");
						}
					};					
				};	
			});		 
		}); 		
		
		$(document).ready(function(){		 
			$('#addNewSkill').on('submit', function(event){
				event.preventDefault();
				//contains data for database only
				var data = {
				"title" : document.getElementById("newSkillTitle").value,
				"description" : document.getElementById("newSkillDescription").value
				};							
				var dataString = JSON.stringify(data);
				//Now send the ShowCase data so it can be added to the database
				$.ajax({
					url:"addNewSkillData.php",
					method: "POST",
					data: {myData: dataString},
					success:function(data){
						alert(data);
					}
				});
			});		 
		});  
		
		var toPrint = '';
		function printPage(){
			//Add sections with skills that need to be selected
			setAdminSkillsData();
			//Now add project data 
			setAdminProjectData();
		}
		//set printPageContents to run when page loads
		window.onload = printPage;
		
		$(document).ready(function(){		 
			$('#uploadProject').on('submit', function(event){
				event.preventDefault();
				//Get image from form and make copies for db
				var file = document.querySelector('#projectImage').files[0];
				var reader = new FileReader();
				var main_image, mobile_image, thumbnail;
				var image = new Image();
				reader.readAsDataURL(file);
				reader.onload = () =>{					
					image.src = reader.result;	
					image.onload = () =>{
						main_image = normalizeImage(image);
						if(main_image != null){
							mobile_image = createMobileImageCopy(main_image);
							thumbnail = createThumbNailCopy(main_image);
							var image_name = $('#projectImage').val();
							var path = document.getElementById('projectImage').value;
							//Get file name with extension
							var file_name;
							if (path) {
								var start = (path.indexOf('\\') >= 0 ? path.lastIndexOf('\\') : path.lastIndexOf('/'));
								file_name = path.substring(start);
								if (file_name.indexOf('\\') === 0 || file_name.indexOf('/') === 0) {
									file_name = file_name.substring(1);
								}
							}
							//document.getElementById("test1").src = main_image;
							//document.getElementById("test2").src = mobile_image;
							//document.getElementById("test3").src = thumbnail;
							//contains data for database only
							var data = {
							"title" : document.getElementById("projectTitle").value,
							"description" : document.getElementById("projectDescription").value,
							"fileName" : file_name
							};							
							var dataString = JSON.stringify(data);
							//Now send the ShowCase data so it can be added to the database
							$.ajax({
								url:"addShowCaseData.php",
								method: "POST",
								data: {myData: dataString},
								success:function(data){
									alert(data);
								}
							});
							//Now send the photos to the server to be saved for future hosting						
							var formData = new FormData();
							formData.append('main', dataURItoBlob(main_image), file_name);
							formData.append('mobile', dataURItoBlob(mobile_image), "M_"+file_name);
							formData.append('thumb', dataURItoBlob(thumbnail), "TN_"+file_name);
							//Now send the ShowCase photos so it can be saved to the server
							$.ajax({
								url:"addShowCasePhotos.php",
								method: "POST",
								data: formData,
								processData: false,
								contentType: false,
								success:function(data){
									//alert(data);
								},
								error: function(XMLHttpRequest, textStatus, errorThrown) {
									alert("Problem: "+XMLHttpRequest.status+" "+XMLHttpRequest.statusText);
								}
							});
						}else{
							alert("Invalid Photo Uploaded");
						}
					};					
				};	
			});		 
		});  
		/* Function Name: dataURItoBlob
		 * Source: https://stackoverflow.com/questions/6850276/how-to-convert-dataurl-to-file-object-in-javascript
		 * Date Written: May 23, 2017
		 * Author: Matthew
		 */
		function dataURItoBlob(dataURI) {
		  // convert base64 to raw binary data held in a string
		  // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
		  var byteString = atob(dataURI.split(',')[1]);
		  // separate out the mime component
		  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
		  // write the bytes of the string to an ArrayBuffer
		  var ab = new ArrayBuffer(byteString.length);
		  // create a view into the buffer
		  var ia = new Uint8Array(ab);
		  // set the bytes of the buffer to the correct values
		  for (var i = 0; i < byteString.length; i++) {
			  ia[i] = byteString.charCodeAt(i);
		  }
		  // write the ArrayBuffer to a blob, and you're done
		  var blob = new Blob([ab], {type: mimeString});
		  return blob;
		}
	</script>
</body>
</html>